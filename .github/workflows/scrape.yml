name: Scrape Tournaments

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:  # Manual trigger

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    env:
      TZ: America/New_York
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Chrome
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable
      
      - name: Install Python packages
        run: |
          pip install selenium webdriver-manager
      
      - name: Check if scraper exists
        run: |
          if [ -f bankshot_monitor_multi.py ]; then
            echo "✓ Scraper file found"
          else
            echo "✗ Scraper file NOT found!"
            ls -la
            exit 1
          fi
      
      - name: Modify scraper for GitHub Actions
        run: |
          cp bankshot_monitor_multi.py scraper_github.py
          
          # Change file paths
          sed -i 's|/home/pi/tournament_data.json|tournament_data.json|g' scraper_github.py
          sed -i 's|/var/www/html/tournament_data.json|tournament_data.json|g' scraper_github.py
          sed -i 's|/home/pi/logs/tournament_monitor.log|scraper.log|g' scraper_github.py
          
          # Replace ChromeDriver setup with webdriver-manager
          python3 << 'EOFPYTHON'
with open('scraper_github.py', 'r') as f:
    content = f.read()

# Find and replace the setup_driver function's service creation
old_code = """    try:
        service = Service(executable_path='/usr/bin/chromedriver')
        return webdriver.Chrome(service=service, options=chrome_options)"""

new_code = """    try:
        from webdriver_manager.chrome import ChromeDriverManager
        service = Service(ChromeDriverManager().install())
        return webdriver.Chrome(service=service, options=chrome_options)"""

content = content.replace(old_code, new_code)

with open('scraper_github.py', 'w') as f:
    f.write(content)
    
print("✓ Patched scraper to use webdriver-manager")
EOFPYTHON
          
          echo "✓ Modified scraper created"
      
      - name: Run tournament scraper
        run: |
          echo "Starting scraper at $(date)"
          python3 scraper_github.py 2>&1 | tee scraper_output.log || true
          echo "Scraper finished at $(date)"
        continue-on-error: true
      
      - name: Check scraper output
        run: |
          echo "=== SCRAPER OUTPUT ==="
          if [ -f scraper_output.log ]; then
            cat scraper_output.log
          fi
          
          echo ""
          echo "=== SCRAPER LOG ==="
          if [ -f scraper.log ]; then
            cat scraper.log
          fi
      
      - name: Verify tournament data
        run: |
          if [ -f tournament_data.json ]; then
            echo "✓ Tournament data file created"
            cat tournament_data.json | python3 -m json.tool
          else
            echo "✗ No tournament data file - creating default"
            echo '{"tournament_name":"No tournaments found","status":null,"display_tournament":false,"last_updated":"'$(date '+%Y-%m-%d %H:%M:%S')'"}' > tournament_data.json
          fi
      
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          
          git add tournament_data.json scraper.log scraper_output.log 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "Update tournament data - $(date '+%Y-%m-%d %I:%M %p EST')" || exit 0
          
          # Push with graceful handling of race conditions
          if git push --force-with-lease origin main; then
            echo "✓ Pushed successfully"
          else
            echo "⚠ Push failed (likely race condition) - next run will sync"
          fi
          
          exit 0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
